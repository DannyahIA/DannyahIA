name: ğŸš€ Update GitHub Profile

on:
  schedule:
    # Executa a cada 6 horas (reduzido para evitar sobrecarga)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
  # PUSH DESABILITADO para evitar loops infinitos
  # Se precisar ativar, use apenas com paths especÃ­ficos e [skip ci] no commit

permissions:
  contents: write

jobs:
  update-profile:
    runs-on: ubuntu-latest
    name: ğŸ“Š Atualizar Perfil GitHub
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“Š Coletar dados do GitHub
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          echo "ğŸ” Coletando dados para: $GITHUB_USERNAME"
          echo "ğŸ“¦ RepositÃ³rio: $GITHUB_REPOSITORY"
          python src/scripts/daily_metrics.py
      
      - name: ğŸ¨ Gerar grÃ¡ficos SVG
        run: |
          echo "ğŸ¨ Gerando grÃ¡ficos SVG..."
          python src/scripts/generate_complete_dashboard.py
      
      - name: ğŸ“ Atualizar README
        run: |
          echo "ğŸ“ Atualizando timestamp do README..."
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          sed -i "s|<!-- AUTO-GENERATED:START (last_update) -->.*<!-- AUTO-GENERATED:END -->|<!-- AUTO-GENERATED:START (last_update) -->$TIMESTAMP<!-- AUTO-GENERATED:END -->|g" README.md 2>/dev/null || true
      
      - name: ğŸ’¾ Commit e Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Adicionar todos os arquivos gerados
          git add assets/*.svg 2>/dev/null || true
          git add data/*.json 2>/dev/null || true
          git add README.md 2>/dev/null || true
          
          # Verificar se hÃ¡ mudanÃ§as
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma mudanÃ§a para commitar"
          else
            git commit -m "ğŸ¤– Auto-update: MÃ©tricas e grÃ¡ficos [$(date +'%Y-%m-%d %H:%M:%S')] [skip ci]" \
              -m "ğŸ“Š MÃ©tricas atualizadas" \
              -m "ğŸ¨ GrÃ¡ficos SVG regenerados" \
              -m "" \
              -m "Gerado por GitHub Actions"
            
            # Fazer pull com rebase antes do push para evitar conflitos
            echo "ğŸ”„ Sincronizando com o repositÃ³rio remoto..."
            git pull --rebase origin ${{ github.ref_name }} || true
            
            # Tentar push com retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "ğŸš€ Tentativa de push $(($RETRY_COUNT + 1))/$MAX_RETRIES..."
              
              if git push origin ${{ github.ref_name }}; then
                echo "âœ… MudanÃ§as enviadas com sucesso!"
                break
              else
                RETRY_COUNT=$(($RETRY_COUNT + 1))
                
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸ Push falhou, aguardando 5 segundos antes de tentar novamente..."
                  sleep 5
                  git pull --rebase origin ${{ github.ref_name }} || true
                else
                  echo "âŒ Falha apÃ³s $MAX_RETRIES tentativas"
                  exit 1
                fi
              fi
            done
          fi
      
      - name: ğŸ“Š Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "## ğŸ“Š Resumo da AtualizaÃ§Ã£o do Perfil" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ•’ **HorÃ¡rio:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ‘¤ **UsuÃ¡rio:** ${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ **RepositÃ³rio:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Status:** ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ Arquivos Gerados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“Š SVGs:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh assets/*.svg 2>/dev/null | tail -n +2 | awk '{print $9, "(" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "Nenhum SVG encontrado" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ğŸ“„ JSONs:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh data/*.json 2>/dev/null | tail -n +2 | awk '{print $9, "(" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "Nenhum JSON encontrado" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mostrar preview das mÃ©tricas
          if [ -f data/metrics.json ]; then
            echo "### ğŸ“ˆ Preview das MÃ©tricas" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat data/metrics.json | jq '{username, total_commits, total_repos, total_prs, total_stars, last_updated}' 2>/dev/null >> $GITHUB_STEP_SUMMARY || cat data/metrics.json | head -15 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ‰ Sucesso
        if: success()
        run: |
          echo "âœ¨ AtualizaÃ§Ã£o do perfil concluÃ­da com sucesso!"
          echo "ğŸ“Š MÃ©tricas coletadas e grÃ¡ficos gerados."
          echo "ğŸš€ Todas as mudanÃ§as foram commitadas."
